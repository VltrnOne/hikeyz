name: Deploy to SiteGround

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    name: Deploy to SiteGround
    runs-on: ubuntu-latest
    
    steps:
      - name: Check deployment status
        run: |
          if [ "${{ secrets.DEPLOYMENT_ENABLED }}" = "false" ]; then
            echo "⚠️  Deployments are currently DISABLED"
            echo "To enable: Set GitHub secret DEPLOYMENT_ENABLED to 'true' or remove it"
            exit 1
          else
            echo "✅ Deployments are ENABLED"
          fi
      
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write SSH key with proper formatting (preserve newlines)
          echo "${{ secrets.SITEGROUND_SSH_KEY }}" > ~/.ssh/siteground_key
          chmod 600 ~/.ssh/siteground_key
          
          # Verify key file was created
          if [ ! -f ~/.ssh/siteground_key ]; then
            echo "❌ ERROR: SSH key file was not created"
            exit 1
          fi
          
          # Check key format
          echo "Checking SSH key format..."
          if grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/siteground_key; then
            echo "✅ SSH key format looks correct"
          else
            echo "⚠️  WARNING: SSH key may be missing BEGIN/END markers"
          fi
          
          # Show key file info (first and last lines only for security)
          echo "Key file info:"
          head -1 ~/.ssh/siteground_key
          echo "..."
          tail -1 ~/.ssh/siteground_key
          echo "Key file size: $(wc -l < ~/.ssh/siteground_key) lines"
          
          # Add host to known_hosts
          ssh-keyscan -p ${{ secrets.SITEGROUND_SSH_PORT }} ${{ secrets.SITEGROUND_SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts
          
          # Test SSH connection (non-blocking - just for info)
          echo ""
          echo "Testing SSH connection..."
          if ssh -i ~/.ssh/siteground_key -p ${{ secrets.SITEGROUND_SSH_PORT }} -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes ${{ secrets.SITEGROUND_SSH_USER }}@${{ secrets.SITEGROUND_SSH_HOST }} "echo 'SSH connection successful'" 2>&1; then
            echo "✅ SSH connection test passed"
          else
            echo "⚠️  SSH connection test failed - this may be normal if key needs authorization"
            echo "   Please verify:"
            echo "   1. SSH key is authorized in SiteGround cPanel → SSH Keys Manager"
            echo "   2. GitHub secret contains the complete private key (all lines)"
            echo "   3. Key has no passphrase"
          fi
      
      - name: Deploy to SiteGround
        env:
          SG_HOST: ${{ secrets.SITEGROUND_SSH_HOST }}
          SG_USER: ${{ secrets.SITEGROUND_SSH_USER }}
          SG_PORT: ${{ secrets.SITEGROUND_SSH_PORT }}
        run: |
          echo "Attempting deployment to $SG_USER@$SG_HOST:$SG_PORT"
          echo "Using SSH key: ~/.ssh/siteground_key"

          # Attempt SSH connection with detailed error output
          ssh -v -i ~/.ssh/siteground_key -p $SG_PORT \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            -o BatchMode=yes \
            -o LogLevel=ERROR \
            $SG_USER@$SG_HOST << 'ENDSSH'
          echo "==================================="
          echo "Starting deployment..."
          echo "==================================="

          # Navigate to application directory (create if doesn't exist)
          echo "Checking application directory..."
          if [ ! -d ~/hikeyz ]; then
            echo "⚠️  Directory ~/hikeyz does not exist. Creating it..."
            mkdir -p ~/hikeyz || { echo "❌ Failed to create directory"; exit 2; }
          fi

          cd ~/hikeyz || { echo "❌ Failed to change to directory"; exit 2; }

          # Pull latest changes from GitHub
          echo "Pulling latest changes from GitHub..."
          if [ -d .git ]; then
            echo "Git repository found, updating..."
            git fetch origin 2>&1 || echo "⚠️  Git fetch failed, continuing..."
            git reset --hard origin/main 2>&1 || echo "⚠️  Git reset failed, continuing..."
            git clean -fd 2>&1 || echo "⚠️  Git clean failed, continuing..."
          else
            echo "⚠️  Not a git repository, initializing..."
            git init || { echo "❌ Failed to initialize git"; exit 2; }
            git remote add origin https://github.com/VltrnOne/hikeyz.git 2>&1 || \
              git remote set-url origin https://github.com/VltrnOne/hikeyz.git 2>&1 || \
              echo "⚠️  Failed to set git remote, continuing..."
            git fetch origin 2>&1 || echo "⚠️  Initial fetch failed, continuing..."
            git reset --hard origin/main 2>&1 || echo "⚠️  Initial reset failed, continuing..."
          fi

          # Update Python dependencies if requirements.txt changed
          echo "Checking for dependency updates..."
          if [ -f "requirements.txt" ]; then
            if [ -f ~/virtualenv/hikeyz/bin/activate ]; then
              echo "Activating virtual environment..."
              if source ~/virtualenv/hikeyz/bin/activate 2>&1; then
                echo "Virtualenv activated successfully"
                pip install --upgrade pip --quiet 2>&1 || echo "⚠️  Pip upgrade failed"
                pip install -r requirements.txt --quiet 2>&1 || echo "⚠️  Dependency installation failed"
                echo "Dependencies updated"
              else
                echo "⚠️  Virtualenv activation failed, trying without it..."
                pip3 install --user --upgrade pip --quiet 2>&1 || echo "⚠️  Pip upgrade failed"
                pip3 install --user -r requirements.txt --quiet 2>&1 || echo "⚠️  Dependency installation failed"
              fi
            else
              echo "⚠️  Virtualenv not found at ~/virtualenv/hikeyz/bin/activate"
              echo "Trying to install dependencies without virtualenv..."
              pip3 install --user --upgrade pip --quiet 2>&1 || echo "⚠️  Pip upgrade failed"
              pip3 install --user -r requirements.txt --quiet 2>&1 || echo "⚠️  Dependency installation failed"
            fi
          else
            echo "⚠️  requirements.txt not found, skipping dependency updates"
          fi

          # Create necessary directories
          echo "Creating necessary directories..."
          mkdir -p ~/hikeyz/downloads 2>&1 || echo "⚠️  Failed to create downloads directory"
          mkdir -p ~/hikeyz/logs 2>&1 || echo "⚠️  Failed to create logs directory"

          # Copy frontend HTML files to web root
          echo "Deploying frontend files to public_html..."
          if [ -d ~/hikeyz/public ]; then
            # Create backup of existing files
            if [ -d ~/public_html ] && [ "$(ls -A ~/public_html 2>/dev/null)" ]; then
              echo "Backing up existing public_html..."
              mkdir -p ~/public_html_backup 2>&1 || echo "⚠️  Failed to create backup directory"
              cp -r ~/public_html/* ~/public_html_backup/ 2>&1 || echo "⚠️  Backup failed"
            fi

            # Create public_html if it doesn't exist
            mkdir -p ~/public_html 2>&1 || echo "⚠️  Failed to create public_html directory"

            # Copy all files from public/ to public_html/
            echo "Copying HTML, CSS, JS files..."
            cp -r ~/hikeyz/public/* ~/public_html/ 2>&1 || echo "⚠️  Failed to copy frontend files"

            # Set proper permissions
            chmod -R 755 ~/public_html 2>&1 || echo "⚠️  Failed to set permissions"

            echo "✓ Frontend files deployed to ~/public_html/"

            # List deployed files
            echo "Deployed files:"
            ls -lh ~/public_html/ 2>&1 || echo "⚠️  Failed to list files"
          else
            echo "⚠️  WARNING: ~/hikeyz/public directory not found!"
          fi

          # Restart Python application (if using SiteGround Python App)
          # Note: SiteGround Python apps auto-restart on file changes
          # If you need manual restart, uncomment the line below:
          # touch ~/hikeyz/api/app.py

          echo "==================================="
          echo "Deployment completed successfully!"
          echo "==================================="
          echo "Frontend deployed to: ~/public_html/"
          echo "Application should auto-restart"
          echo "Check logs in: ~/hikeyz/logs/"
          ENDSSH

          SSH_EXIT_CODE=$?
          if [ $SSH_EXIT_CODE -ne 0 ]; then
            echo ""
            if [ $SSH_EXIT_CODE -eq 255 ]; then
              echo "❌ DEPLOYMENT FAILED: SSH Authentication Error (Exit code: $SSH_EXIT_CODE)"
              echo ""
              echo "Common causes:"
              echo "1. SSH key not authorized in SiteGround cPanel"
              echo "2. SSH key secret missing or incomplete in GitHub"
              echo "3. Wrong SSH credentials in secrets"
              echo ""
              echo "To fix:"
              echo "1. Verify SSH key is authorized: SiteGround cPanel → SSH Keys Manager → Authorize"
              echo "2. Update GitHub secret SITEGROUND_SSH_KEY with complete private key"
              echo "3. Check all 4 secrets are set correctly"
            elif [ $SSH_EXIT_CODE -eq 2 ]; then
              echo "❌ DEPLOYMENT FAILED: Command Error in Deployment Script (Exit code: $SSH_EXIT_CODE)"
              echo ""
              echo "This usually means a command inside the deployment script failed."
              echo "Common causes:"
              echo "1. Application directory doesn't exist and couldn't be created"
              echo "2. Git repository not initialized or wrong remote URL"
              echo "3. Virtual environment path incorrect"
              echo "4. Python/pip not available or permissions issue"
              echo "5. Missing dependencies or requirements.txt issues"
              echo ""
              echo "To fix:"
              echo "1. Check the deployment logs above for the specific error"
              echo "2. Verify the application directory exists: ~/hikeyz"
              echo "3. Check virtualenv path: ~/virtualenv/hikeyz/bin/activate"
              echo "4. Verify git repository is properly initialized"
              echo "5. Test commands manually via SSH"
            else
              echo "❌ DEPLOYMENT FAILED: Unknown Error (Exit code: $SSH_EXIT_CODE)"
              echo ""
              echo "Check the logs above for details."
            fi
            echo ""
            exit $SSH_EXIT_CODE
          fi
      
      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/siteground_key
      
      - name: Deployment Summary
        run: |
          echo "✅ Deployment completed!"
          echo "Changes pushed to SiteGround server"
          echo "Application should be live shortly"

